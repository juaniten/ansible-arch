---
- name: Bootstrap Arch in localhost
  hosts: localhost

  vars:
    # Dotfiles repo info
    dotfiles_repo: "git@github.com:juaniten/dotfiles.git"
    dotfiles_path: "{{ ansible_env.HOME }}/.dotfiles"

    # Packages I want installed
    packages_present:
      - git
      - stow
      - wget
      - yay

    aur_packages_present:
      - hyprmon-bin

    # Packages I explicitly don't want
    packages_absent:
      - 1password
      - typora
      - obs-studio
      - signal-desktop

  tasks:
    # -----------------------------
    # Package management
    # -----------------------------

    - name: Create the `aur_builder` user
      become: yes
      ansible.builtin.user:
        name: aur_builder
        create_home: yes
        group: wheel

    - name: Allow the `aur_builder` user to run `sudo pacman` without a password
      become: yes
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/11-install-aur_builder
        line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
        create: yes
        mode: 0644
        validate: 'visudo -cf %s'

    - name: Ensure Ansible tmp directory exists for aur_builder
      become: yes
      file:
        path: /home/aur_builder/.ansible/tmp
        state: directory
        owner: aur_builder
        group: wheel
        mode: '0700'

    - name: Install AUR packages using yay
      kewlfft.aur.aur:
        use: yay
        name: "{{ aur_packages_present }}"
      become: yes
      become_user: aur_builder

    - name: Ensure unwanted packages are absent
      community.general.pacman:
        name: "{{ packages_absent }}"
        state: absent
      become: true

    # -----------------------------
    # Dotfiles setup
    # -----------------------------
    - name: Clone dotfiles repo
      git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ dotfiles_path }}"
        update: yes  # pull latest changes if repo exists

    - name: Stow dotfiles
      # Clever trick to log task as changed only when links are actually created
      shell: "stow --target {{ ansible_env.HOME }} --verbose=2 $(ls -d */)"
      args:
        chdir: "{{ dotfiles_path }}"
        executable: /bin/bash
      register: result
      changed_when: 'result.stderr is search("LINK: ")'

